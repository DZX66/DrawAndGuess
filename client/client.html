<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>Draw&Guess</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer">
</head>

<body>
    <!-- 画板css -->
    <style>
        body {
            user-select: none;
        }

        .content {
            margin: 20px;
            margin-bottom: 5px;
            float: left;
        }

        .content div {
            margin-bottom: 5px;
            width: 80px;
            text-align: center;
            float: left;
        }

        .toolbar {
            top: -200px;
            height: auto;
            width: 100%;
            position: absolute;
            z-index: 1002;
            background-color: bisque;
            border: 1px solid #ccc;
            transition: all 0.5s cubic-bezier(0, 0.3, 0.58, 1);
        }

        .toolbar.display {
            top: 0;
        }

        .toolbar_btn {
            background: url("assets/toolbar_btn.png");
            background-repeat: no-repeat;
            background-size: 100%;
            background-position: center;
            width: 60px;
            height: 38px;
        }

        .toolbar_btn:hover {
            background-size: 110%;
        }

        .toolbar_btn_container {
            position: absolute;
            right: 0;
            bottom: 0;
            transform-origin: center center;
            transform: rotate(180deg);
        }

        .outside {
            position: absolute;
            top: 0;
            transform: rotate(0deg);
            z-index: 1001;
            height: fit-content;
        }

        #canvas {
            background-color: transparent;
            width: 100%;
            height: 100%;
        }


        .button1 {
            height: 30px;
            width: 80px;
            line-height: 40px;
            font-size: 15px;
            color: gold;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: none;
            margin-right: 12px;
            margin-bottom: 2px;
            text-align: center;
            cursor: pointer;
        }

        .button1:hover {
            color: darkorange;
        }

        .button1:active {
            border: none;
            color: white;
            outline: none;
            background: LightSkyBlue;
        }


        label {
            color: gold;
        }

        label span {
            color: #48c0a4;
        }



        .painter_mode_chose_button {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin: 0 3px;
            cursor: pointer;
            background: url("assets/painter_tools.png");
            background-repeat: no-repeat;
            background-position: var(--normal);
        }

        #画笔 {
            --normal: 0px 0px;
            --active: 0px -23px;
        }

        .painter_mode_chose_button:hover,
        .painter_mode_chose_button.active {
            background-position: var(--active);
        }


        #空心矩形 {
            --normal: 0px -45px;
            --active: 0px -67px;
        }

        #实心矩形 {
            width: 18px;
            height: 18px;
            background: #E89184;
            border-radius: 5px;
        }

        #实心矩形:hover,
        #实心矩形.active {
            background: #F64524;
        }

        #空心圆形 {
            --normal: 0px -90px;
            --active: 0px -113px;
        }

        #实心圆形 {
            width: 18px;
            height: 18px;
            background: #E89184;
            border-radius: 50%;
        }

        #实心圆形:hover,
        #实心圆形.active {
            background: #F64524;
        }

        #直线 {
            --normal: 0px -133px;
            --active: 0px -150px;
        }

        #箭头 {
            --normal: 0px -266px;
            --active: 0px -290px;
        }

        #橡皮 {
            --normal: 0px -218px;
            --active: 0px -241px;
        }

        #brushSizeLine {
            margin: 0;
            padding: 0;
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: gold;
        }

        #brushSizeLine {
            margin: 0;
            padding: 0;
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: gold;
        }
    </style>
    <!-- 其他css-->
    <style>
        body {
            overflow: hidden;
            background: #fefef7;
        }

        .scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .info * {
            margin-bottom: 10px;
        }

        .logo {
            margin-bottom: 30px;
            text-align: center;
        }


        ol {
            margin: 0;
            padding: 0;
            list-style: none;
            width: 200px;
            text-align: left;
        }

        ol li {
            margin-bottom: 10px;
        }

        .info_middle {
            display: flex;
            flex-direction: row;
            justify-content: space-around;
            align-items: flex-start;
        }

        .info_middle div {
            margin-right: 20px;
        }

        #players {
            height: 200px;
            /*超出范围添加滑动条*/
            overflow-y: scroll;
            border: 1px solid #ccc;
        }

        #ready_players {
            height: 200px;
            /*超出范围添加滑动条*/
            overflow-y: scroll;
            border: 1px solid #ccc;
        }

        .pic_btn {
            background: none;
        }

        .chatball {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 70px;
            height: 70px;
            z-index: 1011;
        }

        .chatball button {
            height: 100%;
            width: 100%;
            background: url("assets/chat.png");
            background-repeat: no-repeat;
            background-size: 100%;
            background-position: center;
        }

        .chatball button:hover {
            background-size: 110%;
        }

        .settings_btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 70px;
            height: 70px;
        }

        .settings_btn button {
            height: 100%;
            width: 100%;
            background: url("assets/settings.jpg");
            background-repeat: no-repeat;
            background-size: 100%;
            background-position: center;
        }

        .settings_btn button:hover {
            background-size: 110%;
        }

        .chatbox {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 300px;
            z-index: 1015;
            background-color: aliceblue;
            padding-left: 8px;
            display: flex;
            flex-direction: column;
        }

        .chatbox ul {
            flex: 1;
            overflow-y: scroll;
            padding: 10px;
            /*边框*/
            border: 1px solid #ccc;
            user-select: text;
            list-style: none;
        }

        .chatbox ul li {
            margin-bottom: 10px;
            text-align: left;
        }

        .chatbox form {
            margin-bottom: 10px;
        }

        .chatbox * {
            position: relative;
        }

        .chatbox form {
            display: flex;
        }

        #chat_input {
            flex: 1;
            margin-right: 5px;
            padding-left: 5px;
        }

        .chatbox_close {
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 50px;
        }

        .chatbox_close button {
            height: 100%;
            width: 100%;
            background: url("assets/close.jpeg");
            background-repeat: no-repeat;
            background-size: 100%;
            background-position: center;
        }

        .chatbox_close button:hover {
            background-size: 110%;
        }



        .black {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1010;
        }

        .info_lefttop {
            position: absolute;
            top: 10px;
            width: 100%;
            z-index: 999;
        }

        .bg {
            background-color: aliceblue;
            padding: 1px;
            width: fit-content;
        }

        .info_top {
            position: absolute;
            top: 10px;
            width: 100%;
            z-index: 999;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: center;
        }

        .canvas_container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .drawing_submit {
            position: absolute;
            bottom: 10px;
            left: 10px;
        }

        .submit_btn {
            z-index: 1;
            position: relative;
            background-color: #51d839;
            width: 70px;
            height: 70px;
            transform: rotate(-5deg);
            border: none;
            box-shadow: -4px 4px 1px #ccc;
        }

        .submit_btn div {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 0;
            background-image: url("assets/submit.png");
            background-size: 100% 100%;
            filter: invert(1);
        }

        .submit_btn::before {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 100%;
            background-color: #ffc742;
            z-index: -1;
            content: "";
        }


        .pressed::before {
            transition: all 1s cubic-bezier(0, 0.4, 0.58, 1);
            top: 0;
        }

        .submit_btn:hover div {
            filter: invert(0);
        }

        .pic {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: no-repeat center center fixed;
            background-size: contain;
            z-index: 0;
        }

        .info_bottom {
            position: absolute;
            bottom: 10px;
            width: 100%;
            z-index: 999;
            border-top: 1px solid #ccc;
            display: flex;
            justify-content: center;
            right: 30px;
        }

        .center_window {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1011;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .center_window>div {
            background-color: antiquewhite;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ccc;

        }

        footer {
            color: gray;
            font-size: xx-small;
        }

        #chat_preview {
            position: absolute;
            right: 20px;
            bottom: 120px;
            height: 40%;
            width: 200px;
            z-index: 1000;
            pointer-events: none;
        }

        #chat_preview ul {
            font-size: small;
            margin: 0;
            padding: 0;
            list-style: none;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #chat_preview ul li {
            margin-bottom: 2px;
            color: turquoise;
        }

        .fade {
            animation-name: fade;
            animation-duration: 0.3s;
            -webkit-animation-name: fade;
            /* Safari 和 Chrome */
            -webkit-animation-duration: 0.3s;
        }

        @keyframes fade {
            from {
                opacity: 0.4;
            }

            to {
                opacity: 0.9;
            }
        }

        @-webkit-keyframes fade {

            /* Safari 和 Chrome */
            from {
                opacity: 0.4;
            }

            to {
                opacity: 0.9;
            }
        }

        #painter_mode_btns {
            width: auto;
            margin-bottom: 0;
        }

        .painter_color_chose_button {
            display: block;
            width: 20px;
            height: 20px;
            margin: 2px 2px;
            border: #ccc solid 3px;
            border-radius: 30%;
            float: left;
            cursor: pointer;
        }

        .painter_color_chose_button:hover {
            border: #b5b3e0 solid 3px;
        }

        .linewidth_chose_button {
            float: left;
            width: 1em;
            min-width: 8px;
            height: 30px;
            position: relative;
            padding: 0 6px;

        }

        .linewidth_chose_button::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            margin: auto;
            background: #333;
            border-radius: 9em;
            width: 1em;
            height: 1em;
        }

        .linewidth_chose_button:hover::before {
            border: #b5b3e0 solid 2px;
        }

        .linewidth_chose_button.active::before {
            border: #b5b3e0 solid 3px;
        }

        #painter_linewidth_btns {
            width: auto;
        }

        #painter_linewidth_btns div {
            width: auto;
        }

        .color_shortcut {
            width: auto !important;
        }

        .color_shortcut>div {
            width: auto;
        }

        .color_shortcut>div>div {
            width: auto;
        }

        .color_shortcut>div>div>div {
            width: 28px;
        }

        .first_word_option {
            margin-right: 10px;
            width: 140px;
            height: 70px;
        }

        .ping_info {
            position: absolute;
            bottom: 100px;
            left: 2px;
        }

        #settings {
            background-color: rgba(0, 0, 0, 0.5);
        }

        #settings>div {
            height: 90%;
            width: 50%;
            scroll-behavior: smooth;
            overflow-y: auto;
        }

        #settings label {
            color: #000000;
            font-size: 18px;
        }

        #settings form>div {
            display: flex;
            justify-content: space-between;
        }

        #settings .buttons {
            justify-content: space-evenly;
        }

.ready-status {
    width: 20px;
    height: 20px;
    margin-left: 10px;
    vertical-align: middle;
}
    </style>

    <div id="server" class="scene info">
        <img src="assets/logo.png" alt="logo" width="320px" height="75px" class="logo">
        <form action="javascript:void(0);"
            onsubmit="if(localStorage.getItem('unfinished_game')){alert('还有未完成的游戏，即将尝试重连。');}connectServer()"
            style="display: flex;flex-direction: column;">
            <input type="text" id="nickname" placeholder="你的昵称..." style="width: 200px;" maxlength="10">
            <input type="text" id="server_url" placeholder="服务器地址..." style="width: 200px;">
            <button type="submit">连接服务器</button>
        </form>
        <p><button onclick="clearStorage()">清空用户数据</button></p>
        <footer><span id="version"></span> <a
                href="javascript:openURL('https://github.com/DZX66/DrawAndGuess')">Github</a></footer>
        </footer>
        <!-- 设置按钮 -->
        <div class="settings_btn"><button onclick="showSettings()"></button></div>
    </div>

    <div id="prepare" style="display: none;" class="scene info">
        <h1>准备阶段</h1>
        <div class="info_middle">
            <div>
                <ol id="players"></ol>
                <span>人数：<span id="num_of_players"></span></span>
            </div>
            <div>
                <table border="1">
                    <caption>房间设置</caption>
                    <tr>
                        <th>词库</th>
                        <th id="wordbook_name"></th>
                    </tr>
                    <tr>
                        <th>回合数</th>
                        <th id="turn_num"></th>
                    </tr>
                </table>
            </div>
        </div>
    <button id="readyBtn" onclick="toggleReady()">准备游戏</button>
    <p id="waitingText" style="display: none;">等待开始游戏...</p>
    </div>

    <div id="drawing_phase" style="display: none;" class="scene">
        <div class="info_lefttop">
            <div class="bg"><img src="assets/countdown.jpg" alt="倒计时" width="30px" height="30px"><span
                    id="countdown_draw"></span></div>
        </div>
        <div class="info_top">
            <div class="bg">题目：<span id="word"></span></div>
        </div>
        <div class="board">
            <div class="toolbar" id="toolbar">
                <div class="content">
                    <div style="float: left;">
                        <button class="button1" onclick="clearCanvas()">清空</button>
                        <button class="button1" onclick="undo()">撤销</button>
                    </div>
                    <div style="float: left;">
                        <button class="button1" onclick="restore()">恢复</button>
                        <button class="button1" onclick="save_pic()">保存</button>
                    </div>
                    <div>
                        <input type="color" id="brushColor" style="width: 78px;">
                    </div>

                    <div style="float: left;">
                        <div>
                            <span class="painter_mode_chose_button" id="画笔" onclick="change_mode('画笔',7);"></span>
                            <span class="painter_mode_chose_button" id="橡皮" onclick="change_mode('橡皮',8);"></span>
                        </div>

                    </div>
                    <div id="painter_mode_btns">
                        <div style="float: left;">
                            <div>
                                <span class="painter_mode_chose_button" id="空心矩形"
                                    onclick="change_mode('空心矩形',1);"></span>
                                <span class="painter_mode_chose_button" id="实心矩形"
                                    onclick="change_mode('实心矩形',2);"></span>
                            </div>
                            <div>
                                <span class="painter_mode_chose_button" id="空心圆形"
                                    onclick="change_mode('空心圆形',3);"></span>
                                <span class="painter_mode_chose_button" id="实心圆形"
                                    onclick="change_mode('实心圆形',4);"></span>
                            </div>
                            <div>
                                <span class="painter_mode_chose_button" id="直线" onclick="change_mode('直线',5);"></span>
                                <span class="painter_mode_chose_button" id="箭头" onclick="change_mode('箭头',6);"></span>
                            </div>
                        </div>
                    </div>
                    <div class="color_shortcut">
                        <div>
                            <div style="float: left;">
                                <div>
                                    <span class="painter_color_chose_button" style="background-color: #000000;"
                                        onclick="change_color('#000000');"></span>
                                    <span class="painter_color_chose_button" style="background-color: #666666;"
                                        onclick="change_color('#666666');"></span>
                                </div>
                            </div>
                            <div style="float: left;">
                                <div>
                                    <span class="painter_color_chose_button" style="background-color: #d20000;"
                                        onclick="change_color('#d20000');"></span>
                                    <span class="painter_color_chose_button" style="background-color: #1317f6;"
                                        onclick="change_color('#1317f6');"></span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="float: left;">
                                <div>
                                    <span class="painter_color_chose_button" style="background-color: #f8c94e;"
                                        onclick="change_color('#f8c94e');"></span>
                                    <span class="painter_color_chose_button" style="background-color: #f3b2aa;"
                                        onclick="change_color('#f3b2aa');"></span>
                                </div>
                            </div>
                            <div style="float: left;">
                                <div>
                                    <span class="painter_color_chose_button" style="background-color: #3b0c9b;"
                                        onclick="change_color('#3b0c9b');"></span>
                                    <span class="painter_color_chose_button" style="background-color: #008d26;"
                                        onclick="change_color('#008d26');"></span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div style="float: left;">
                                <div>
                                    <span class="painter_color_chose_button" style="background-color: #ff7829;"
                                        onclick="change_color('#ff7829');"></span>
                                    <span class="painter_color_chose_button" style="background-color: #732d07;"
                                        onclick="change_color('#732d07');"></span>
                                </div>
                            </div>
                            <div style="float: left;">
                                <div>
                                    <span class="painter_color_chose_button" style="background-color: #ff008f;"
                                        onclick="change_color('#ff008f');"></span>
                                    <span class="painter_color_chose_button" style="background-color: #25c9ff;"
                                        onclick="change_color('#25c9ff');"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="painter_linewidth_btns">
                        <div><span class="linewidth_chose_button" id="linewidth_1"
                                onclick="change_linewidth(1,2.2155975341796874);" style="font-size: 2px;"></span></div>
                        <div><span class="linewidth_chose_button" id="linewidth_2"
                                onclick="change_linewidth(2,3.323396301269531);" style="font-size: 4px;"></span></div>
                        <div><span class="linewidth_chose_button" id="linewidth_3"
                                onclick="change_linewidth(3,6.646792602539062);" style="font-size: 10px;"></span></div>
                        <div><span class="linewidth_chose_button" id="linewidth_4"
                                onclick="change_linewidth(4,20.18578643798828);" style="font-size: 20px;"></span></div>
                    </div>

                </div>
                <div class="toolbar_btn_container"><button onclick="toolbar()" class="toolbar_btn"></button></div>
            </div>
            <div class="toolbar_btn_container outside"><button onclick="toolbar()" class="toolbar_btn"></button></div>
            <div class="canvas_container">
                <canvas id="canvas" width="1340" height="700"></canvas>
            </div>
        </div>
        <div class="drawing_submit">
            <button class="submit_btn" id="confirmButton">
                <div></div>
            </button>
        </div>
    </div>

    <div id="first_word_options" style="display: none;" class="center_window">
        <div>
            <h3>请选择一个词语，然后画它！</h3>
            <ul id="first_word_options_list"></ul>
        </div>
    </div>

    <div id="waiting" style="display: none;" class="center_window">
        <div>
            <h3>等待其他玩家...(<span id="ready_players_num"></span>)</h3>
            <ol id="ready_players"></ol>
        </div>
    </div>


    <div id="guess_phase" style="display: none;" class="scene">
        <div class="info_lefttop">
            <div class="bg"><img src="assets/countdown.jpg" alt="倒计时" width="30px" height="30px"><span
                    id="countdown_guess"></span></div>
        </div>
        <div id="pic" class="pic"></div>
        <div class="info_top">
            <div class="bg">
                <form action="javascript:void(0);" onsubmit="submitGuess()">
                    <input type="text" id="guess" placeholder="这是什么？" style="width: 140px;" autocomplete="off"
                        maxlength="14">
                    <button type="submit">提交</button>
                </form>
            </div>
        </div>
    </div>

    <div id="appreciation_phase" style="display: none;" class="scene">
        <div class="info_top">
            <div class="bg"><span id="drawer"></span>画了：<span id="appr_word"></span></div>
        </div>
        <div id="appr_pic" class="pic"></div>
        <div class="info_bottom">
            <div class="bg"><span id="guesser"></span></div>
        </div>

        <div class="center_window" style="display: none;" id="match_window">
            <div>
                <p><img src="assets/countdown.jpg" alt="倒计时" width="30px" height="30px"><span
                        id="countdown_appreciation"></span></p>
                <p id="appreciation_result"></p>
                <p id="is_match">这个匹配吗？</p>
                <button onclick="match('1')">匹配</button>
                <button onclick="match('0')" id="unmatch">不匹配</button>
            </div>
        </div>
        <div class="center_window" style="display: none;" id="first_word_window">
            <div>
                第一个词是...
                <span id="first_word_display"></span>
            </div>
        </div>
    </div>

    <div id="favourite" style="display: none;" class="center_window">
        <div>
            <div id="if_not_the_one">
                <span id="the_one"></span>正在选择ta最喜欢的画作...
            </div>
            <div style="display: none;" id="if_the_one">
                <p>你最喜欢哪幅图？</p>
            </div>
            <p><img src="assets/countdown.jpg" alt="倒计时" width="30px" height="30px"><span
                    id="countdown_favourite"></span></p>
            <ol id="choice_list" style="width: 90%;"></ol>
        </div>
    </div>

    <div id="favourite_choosed" style="display: none;" class="center_window">
        <div>
            <p><span id="chooser"></span>选择了ta最喜欢的画作：</p>
            <img id="favourite_pic" src="" alt="图片" width="200px" height="200px">
        </div>
    </div>

    <div id="game_over" style="display: none;" class="scene">
        <h2>游戏结束</h2>
        <ol id="rank"></ol>
        <button onclick="restart()">再来一局</button>
        <button onclick="save_game_data();">保存游戏数据（没做）</button><!-- to do -->
    </div>


    <div class="chatball" title="聊天(T / Enter)"><button class="pic_btn" onclick="chatbox()"></button></div>
    <div class="black" id="black" style="display: none;"></div>
    <div id="chat" class="chatbox" style="display: none;">
        <h2>消息</h2>
        <ul id="messages"></ul>
        <form action="javascript:void(0);" onsubmit="chat_send()">
            <input id="chat_input" autocomplete="off" />
            <button type="submit">发送</button>
        </form>
        <div class="chatbox_close" title="关闭(Esc)"><button onclick="chatbox()" class="pic_btn"></button></div>
    </div>

    <div id="chat_preview">
        <ul id="chat_preview_list">
        </ul>
    </div>

    <div class="ping_info" id="ping"></div>

    <div id="settings" class="center_window" style="display: none;">
        <div>
            <h2>设置</h2>
            <form action="javascript:void(0);" onsubmit="change_settings()">
                <div><label>PC全屏</label><input type="button" value="按F11" disabled></div>
                <div>
                    <label for="game_progress">游戏进度通知</label>
                    <input type="checkbox" id="game_progress" name="game_progress" checked>
                </div>
                <div>
                    <label for="chat_sound">聊天提示音</label>
                    <input type="checkbox" id="chat_sound" name="chat_sound" checked>
                </div>
                <div>
                    <label for="shape_tool">更多画图工具</label>
                    <input type="checkbox" id="shape_tool" name="shape_tool">
                </div>
                <div>
                    <label for="girl_when_waiting">准备阶段的二次元小人</label>
                    <input type="checkbox" id="girl_when_waiting" name="girl_when_waiting" checked>
                </div>
                <div class="buttons">
                    <input type="submit" value="保存并重启"><input type="button" value="取消" onclick="closeSettings()">
                </div>
        </div>
    </div>
    <script>
        // 游戏核心代码
        var version = "0.3";
        var socket;
        var nickname;
        var player_id = "";
        var players;
        var phase = "end";  // prepare, draw, guess, appreciation, checktime, favourite, end
        var the_one;  // 选择最喜欢的画作阶段中，那个选择的人(name)
        var is_black = false;  // 除了聊天框，是否有其他功能需求遮罩层
        var appreciation;
        var ready_num;
        var ping_start_time = 0;
        var is_touch = false;  // 是否为触摸设备
        var colorpicker;
var isReady = false;

        var scenes = ["server", "prepare", "drawing_phase", "guess_phase", "appreciation_phase", "game_over"]
        var items = ["players", "turn_now", "num_turn", "chains"]

        // 检查是否保存了用户名，服务器地址，id
        if (localStorage.getItem('dg_nickname')) {
            nickname = localStorage.getItem('dg_nickname');
            document.getElementById('nickname').value = nickname;
        }
        if (localStorage.getItem('dg_server_url')) {
            serverUrl = localStorage.getItem('dg_server_url');
            document.getElementById('server_url').value = serverUrl;
        }

        if (localStorage.getItem('dg_id')) {
            player_id = localStorage.getItem('dg_id');
        }


        function connectServer() {
            var serverUrl = document.getElementById('server_url').value;
            nickname = document.getElementById('nickname').value;
            // 检查输入是否合法
            if (!serverUrl) {
                alert('请输入服务器地址');
                return;
            }
            if (!nickname) {
                alert('请输入昵称');
                return;
            }
// 检查昵称是否合法
            if (!/^[\u4e00-\u9fa5a-zA-Z0-9_]+$/.test(nickname)) {
                alert('昵称只能包含汉字、字母、数字、下划线');
return;
            }
            // 保存用户名和服务器地址
            localStorage.setItem('dg_nickname', nickname);
            localStorage.setItem('dg_server_url', serverUrl);
            serverUrl = serverUrl.replace("http://", "");
            serverUrl = serverUrl.replace("https://", "");
            socket = new WebSocket("ws://" + serverUrl);
            socket.onopen = function () {
                console.log('WebSocket连接成功');
                if (localStorage.getItem('unfinished_game')) {
                    socket.send("[reconnect]" + player_id);
                } else {
                    socket.send("[initialization]" + nickname + "," + player_id + "," + version);
                }
            };
            socket.onmessage = function (event) {
                console.log('服务器返回消息：', event.data);
                // 如果是"name_exists"，表示昵称已存在
                if (event.data == 'name_exists') {
                    alert('房间内已有同名玩家，请更换昵称');
                    return_to_main();
                    return;
                }
                // 如果是"playing"，表示游戏已经开始
                else if (event.data == 'playing') {
                    alert('游戏已经开始，请等待下一局');
                    return_to_main();
                    return;
                }
                // 如果是"start"，表示游戏开始
                else if (event.data == 'start') {
                    if (settings.game_progress) {
                        chat('<span style="color: gold">游戏开始</span>');
                    }
                    localStorage.setItem('unfinished_game', true);
                }
                else if (event.data.startsWith('[new_player]')) {
                    var player = event.data.substring(12);
                    var li = document.createElement('li');
                    li.innerHTML = "<span>"+player+"</span>";
                    document.getElementById('players').appendChild(li);
updatePlayerReadyStatus(player, false);
                    document.getElementById('num_of_players').textContent = document.getElementById('players').getElementsByTagName('li').length;

                    chat('<span style="color: gold">' + player + '加入了游戏' + '</span>');
                    players.push(player);
                }
                // 如果以[all_players]开头，表示返回了一个包含所有玩家的json列表
else if (event.data.startsWith('[all_players]')) {
    players = JSON.parse(event.data.substring(13));
    document.getElementById('players').innerHTML = '';
    players.forEach(function (player) {
        var li = document.createElement('li');
        li.innerHTML = "<span>"+player[0]+"</span>";
        document.getElementById('players').appendChild(li);
updatePlayerReadyStatus(player[0], player[1]);
    });
    document.getElementById('num_of_players').textContent = players.length;
}
                // 如果以[id]开头，表示返回了玩家的id
                else if (event.data.startsWith('[id]')) {
                    player_id = event.data.substring(4);
                    localStorage.setItem('dg_id', player_id);
                }
                // 如果以[draw]开头，表示进入画图阶段
                else if (event.data.startsWith('[draw]')) {
                    phase = 'draw';
                    document.getElementById('ready_players').innerHTML = '';
                    ready_num = 0;
                    clearCanvas();
                    change_linewidth(2, 3.323396301269531);
                    document.getElementById('prepare').style.display = 'none';
                    clear_window();
                    document.getElementById('toolbar').classList.remove('display');
                    document.getElementById('guess_phase').style.display = 'none';
                    document.getElementById('drawing_phase').style.display = '';
                    document.getElementById('word').textContent = event.data.substring(6);
                    var time = 120;
                    document.getElementById('countdown_draw').textContent = time;
                    document.getElementById('countdown_draw').style.color = 'black';
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_draw').textContent = time;
                        if (time == 3) { new Audio('assets/countdown.mp3').play(); document.getElementById('countdown_draw').style.color = 'red'; }
                        if (time <= 0 || phase != 'draw') {
                            if (time <= 0) { submit_pic(); }
                            clearInterval(interval);
                        }
                    }, 1000);
                }
                // 如果以[guess]开头，表示返回了题目
                else if (event.data.startsWith('[guess]')) {
                    phase = 'guess';
                    document.getElementById('ready_players').innerHTML = '';
                    ready_num = 0;
                    document.getElementById('guess').value = '';
                    clear_window();
                    document.getElementById('drawing_phase').style.display = 'none';
                    document.getElementById('guess_phase').style.display = '';
                    document.getElementById('pic').style.backgroundImage = "url(" + event.data.substring(7) + ")";
                    var time = 60;
                    document.getElementById('countdown_guess').textContent = time;
                    document.getElementById('countdown_draw').style.color = 'black';
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_guess').textContent = time;
                        if (time == 3) { new Audio('assets/countdown.mp3').play(); document.getElementById('countdown_draw').style.color = 'red'; }
                        if (time <= 0 || phase != 'guess') {
                            if (time <= 0) { submitGuess(); }
                            clearInterval(interval);
                        }
                    }, 1000);
                }
                // 如果以[done]开头，表示有人完成
                else if (event.data.startsWith('[done]')) {
                    var id = event.data.substring(6);
                    if (settings.game_progress) {
                        chat('<span style="color: gold">' + id + '完成了' + '</span>');
                    }
                    var li = document.createElement('li');
                    li.innerHTML = id + "<img src='assets/right.png' width='20' height='20'>";
                    document.getElementById('ready_players').appendChild(li);
                    ready_num++;
                    document.getElementById('ready_players_num').textContent = ready_num + '/' + players.length;
                }
                // 如果以[appreciation]开头，表示返回了json评价
                else if (event.data.startsWith('[appreciation]')) {
                    phase = 'appreciation';
                    document.getElementById('black').style.display = 'none';
                    document.getElementById('chat').style.display = 'none';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('favourite_choosed').style.display = 'none';
                    is_black = false;
                    document.getElementById('guess_phase').style.display = 'none';
                    document.getElementById('appreciation_phase').style.display = '';
                    document.getElementById('favourite').style.display = 'none';
                    appreciation = JSON.parse(event.data.substring(14));


                    document.getElementById('first_word_window').style.display = '';
                    document.getElementById('first_word_display').textContent = '';
                    document.getElementById('guesser').textContent = '';
                    document.getElementById('drawer').textContent = '';
                    document.getElementById('appr_word').textContent = '';
                    new Audio("assets/announce.mp3").play();

                    var pic_index = 0;

                    setTimeout(function () {
                        document.getElementById('first_word_display').textContent = appreciation.first_word;
                    }, 690);

                    setTimeout(function () {
                        document.getElementById('first_word_window').style.display = 'none';
                        cyclic_bar();
                    }, 3000);


                    function cyclic_bar() {
                        var index = 0;
                        /** @type {list<string>} */
                        var picture = appreciation.pictures[pic_index];
                        document.getElementById('drawer').textContent = appreciation.players[pic_index * 2];
                        if (pic_index == 0) {
                            document.getElementById('appr_word').textContent = appreciation.first_word;
                        } else {
                            document.getElementById('appr_word').textContent = appreciation.words[pic_index - 1];
                        }
                        var guesser = document.getElementById("guesser");
                        var guesser_text = appreciation.words[pic_index];
                        guesser.textContent = appreciation.players[pic_index * 2 + 1];
                        function a() {
                            document.getElementById("appr_pic").style.backgroundImage = "url(" + picture[index] + ")";
                            index++;
                            if (index > picture.length - 1) {
                                new Audio("assets/announce.mp3").play();
                                setTimeout(function () {
                                    if (guesser_text.endsWith("(新词)")) {
                                        guesser.textContent += " 什么也没猜到！新词：" + guesser_text.substring(0, guesser_text.length - 3);
                                    } else {
                                        guesser.textContent += " 猜了：" + guesser_text;
                                    }
                                }, 690);

                                setTimeout(function () {
                                    pic_index++;

                                    if (pic_index < appreciation.pictures.length) {
                                        cyclic_bar();
                                    } else {
                                        document.getElementById('waiting').style.display = '';
                                        document.getElementById('black').style.display = '';
                                        is_black = true;
                                        socket.send("[ready]");
                                    }
                                }, 5000);
                                clearInterval(timer);
                            }


                        }
                        var timer = setInterval(a, 500);
                        a();


                    }




                    document.getElementById('appreciation_result').textContent = appreciation.first_word + " -> " + appreciation.words[appreciation.words.length - 1];
                    if (appreciation.first_word == appreciation.words[appreciation.words.length - 1]) {
                        document.getElementById('is_match').innerHTML = "完全匹配！";
                        document.getElementById('unmatch').style.display = 'none';
                    } else { document.getElementById('unmatch').style.display = ''; document.getElementById('is_match').innerHTML = "这个匹配吗？"; }

                    document.getElementById('ready_players').innerHTML = '';
                    ready_num = 0;
                    // 设置#choice_list的内容

                    var choice_list = document.getElementById('choice_list');
                    choice_list.innerHTML = '';
                    for (var i = 0; i < appreciation.pictures.length; i++) {
                        var option = document.createElement('button');
                        option.value = i;
                        option.innerHTML = "<img src='" + appreciation.pictures[i][appreciation.pictures[i].length - 1] + "' width='100px' height='100px'>";
                        option.onclick = choosePicture(i);
                        option.classList.add('choice_button');
                        choice_list.appendChild(option);
                    }



                }
                // 如果是[checktime]，则表示进入给出评价阶段
                else if (event.data.startsWith('[checktime]')) {
                    phase = 'checktime';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('match_window').style.display = '';
                    document.getElementById('black').style.display = '';
                    is_black = true;
                    var time = 20;
                    document.getElementById('countdown_appreciation').textContent = time;
                    document.getElementById('countdown_draw').style.color = 'black';
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_appreciation').textContent = time;
                        if (time == 3) { new Audio('assets/countdown.mp3').play(); document.getElementById('countdown_draw').style.color = 'red'; }
                        if (time <= 0 || phase != 'checktime') {
                            clearInterval(interval);
                        }
                    }, 1000);
                }
                // 如果以[favourite]开头，则表示进入评价最喜欢的画作阶段
                else if (event.data.startsWith('[favourite]')) {
                    phase = 'favourite';
                    document.getElementById('favourite').style.display = '';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('match_window').style.display = 'none';
                    document.getElementById('black').style.display = '';
                    is_black = true;
                    if (nickname == event.data.substring(11)) {
                        document.getElementById('if_the_one').style.display = '';
                        document.getElementById('if_not_the_one').style.display = 'none';
                        Array.prototype.forEach.call(document.getElementsByClassName('choice_button'), function (button) {
                            button.disabled = false;
                        });
                        // #choic_list的内容在appreciation阶段设置

                    } else {
                        document.getElementById('the_one').innerHTML = event.data.substring(11);
                        document.getElementById('if_the_one').style.display = 'none';
                        document.getElementById('if_not_the_one').style.display = '';
                        Array.prototype.forEach.call(document.getElementsByClassName('choice_button'), function (button) {
                            button.disabled = true;
                        });
                    }
                    var time = 20;
                    document.getElementById('countdown_favourite').textContent = time;
                    document.getElementById('countdown_draw').style.color = 'black';
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_favourite').textContent = time;
                        if (time == 3) { new Audio('assets/countdown.mp3').play(); document.getElementById('countdown_draw').style.color = 'red'; }
                        if (time <= 0 || phase != 'favourite') {
                            clearInterval(interval);
                        }
                    }, 1000);
                }
                // 如果以[favourite_choosed]开头，则表示最喜欢的画作被选择了
                else if (event.data.startsWith('[favourite_choosed]')) {
                    new Audio("assets/win.mp3").play();
                    document.getElementById('favourite').style.display = 'none';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('favourite_choosed').style.display = '';
                    document.getElementById('chooser').textContent = appreciation.players[appreciation.players.length - 1];
                    document.getElementById('favourite_pic').src =
                        appreciation.pictures[event.data.substring(19)][appreciation.pictures[event.data.substring(19)].length - 1];
                    if (settings.game_progress) {
                        chat('<span style="color: gold">' + "第" + (Number(event.data.substring(19)) + 1) + "张画作被选为最喜欢的画作" + "</span>");
                    }
                }
                // 如果以[checked]开头，表示有人已经评价了画作
                else if (event.data.startsWith('[checked]')) {
                    var data = event.data.substring(9).split(',');
                    if (settings.game_progress) {
                        chat('<span style="color: gold">' + data[0] + "评价：" + data[1] + "</span>");
                    }
                    var rd_players = document.getElementById('ready_players');
                    rd_players.appendChild(document.createElement('li')).innerHTML = data[0] + "<img height='20px' width='20px' src='assets/" + data[1] + ".png'>";
                    ready_num++;
                    document.getElementById('ready_players_num').innerHTML = ready_num + "/" + players.length;
                    new Audio("assets/check.mp3").play();
                }
                // 如果以[end]开头，则表示游戏结束
                else if (event.data.startsWith('[end]')) {
                    phase = 'end';
                    localStorage.setItem('unfinished_game', '');
                    document.getElementById('game_over').style.display = '';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('appreciation_phase').style.display = 'none';
                    document.getElementById('favourite').style.display = 'none';
                    document.getElementById('favourite_choosed').style.display = 'none';
                    document.getElementById('black').style.display = 'none';
                    is_black = false;
                    document.getElementById('chat').style.display = 'none';
                    var grades = event.data.substring(5); //这是json字符串数组
                    grades = JSON.parse(grades); //将json字符串数组转换为JavaScript数组
                    var rank_display = document.getElementById('rank');
                    rank_display.innerHTML = '';
                    for (var i = 0; i < grades.length; i++) {
                        var rank_item = document.createElement('li');
                        rank_item.innerHTML = grades[i][0] + '：' + grades[i][1];
                        rank_display.appendChild(rank_item);
                    }
                }
                // 如果以[leave]开头，则表示有人离开了房间
                else if (event.data.startsWith('[leave]')) {
                    var data = event.data.substring(7);
                    chat('<span style="color: gold">' + data + "离开了房间" + "</span>");
                    if (phase == "prepare") {
                        if (players.indexOf(data) != -1) {
                            players.splice(players.indexOf(data), 1);
                            document.getElementById('players').innerHTML = '';
                            players.forEach(function (player) {
                                var li = document.createElement('li');
                                li.textContent = player;
                                document.getElementById('players').appendChild(li);
                            });
                            document.getElementById('num_of_players').textContent = document.getElementById('players').getElementsByTagName('li').length;
                        }
                    }
                }
                // 如果以[chat]开头，表示有人发送了消息
                else if (event.data.startsWith('[chat]')) {
                    var data = event.data.substring(6);
                    if (settings.chat_sound) {
                        new Audio("assets/notice.mp3").play();
                    }
                    chat(data);
                }
                // 如果是p，表示返回了响应ping
                else if (event.data == 'p') {
                    let p = (new Date().getTime() - ping_start_time)
                    if (p < 100) {
                        var color = "green";
                    } else if (p < 1000) {
                        var color = "orange";
                    } else {
                        var color = "red";
                    }
                    document.getElementById('ping').innerHTML = "<span style='color:" + color + "'>ping:" + p + "ms</span>";
                    ping_start_time = 0;
                }
                // 如果是[not_admin]，表示不是管理员
                else if (event.data == '[not_admin]') {
                    chat('<span style="color: red">你没有运行此命令的权限。</span>');
                }
                // 如果以[wordbook]开头，表示返回了词库
                else if (event.data.startsWith('[wordbook]')) {
                    var data = event.data.substring(10);
                    document.getElementById('wordbook_name').innerHTML = data;
                    chat('<span style="color: gray">词库被修改：' + data + '</span>');
                }
                // 如果是[set_wordbook_error]，表示设置词库失败
                else if (event.data == '[set_wordbook_error]') {
                    chat('<span style="color: red">词库不存在。</span>');
                }
                // 重连相关
                else if (event.data.startsWith('preparing')) {
                    alert("游戏已经结束");
                    localStorage.setItem('unfinished_game', '');
                    return_to_main();
                }
                else if (event.data.startsWith('[refuse]')) {
                    alert("错过了时机，无法加入游戏");
                    localStorage.setItem('unfinished_game', '');
                    return_to_main();
                }
                else if (event.data.startsWith('[reconnect_success]')) {
                    chat('<span style="color: gray">重新连接成功！注意：重连还在开发中，有一堆bug！</span>');
                    if (parseInt(event.data.substring(19)) % 2 == 0) {
                        phase = "draw";
                        document.getElementById('drawing_phase').style.display = '';
                        document.getElementById('guess_phase').style.display = 'none';
                        document.getElementById('prepare').style.display = 'none';
                        document.getElementById('server').style.display = 'none';
                    } else {
                        phase = "guess";
                        document.getElementById('drawing_phase').style.display = 'none';
                        document.getElementById('guess_phase').style.display = '';
                        document.getElementById('prepare').style.display = 'none';
                        document.getElementById('server').style.display = 'none';
                    }

                }
                else if (event.data.startsWith('[reconnected]')) {
                    chat('<span style="color: gold">' + event.data.substring(13) + "重新加入了房间" + "</span>");
                }
                else if (event.data.startsWith('not_found')) {
                    alert("找不到游戏");
                    localStorage.setItem('unfinished_game', '');
                    return_to_main();
                }
                // 如果是version_error，表示版本错误
                else if (event.data.startsWith('version_error')) {
                    alert("版本错误，请更新客户端");
                    localStorage.setItem('unfinished_game', '');
                    return_to_main();
                }
                // 如果以[turn_num]开头，表示返回了轮数
                else if (event.data.startsWith('[turn_num]')) {
                    var turn_num = parseInt(event.data.substring(10));
                    if (turn_num == 0) { turn_num = "=玩家数"; }
                    document.getElementById('turn_num').innerHTML = turn_num;
                    chat('<span style="color: gray">回合数被修改：' + turn_num + '</span>');
                }
                // 如果以[draw_with_options]开头，表示返回了画图选项
                else if (event.data.startsWith('[draw_with_options]')) {
                    phase = 'draw';
                    document.getElementById('ready_players').innerHTML = '';
                    ready_num = 0;
                    clearCanvas();
                    change_linewidth(2, 3.323396301269531);
                    document.getElementById('prepare').style.display = 'none';
                    clear_window();
                    document.getElementById('toolbar').classList.remove('display');
                    document.getElementById('guess_phase').style.display = 'none';
                    document.getElementById('drawing_phase').style.display = '';
                    document.getElementById('first_word_options').style.display = '';
                    var options = JSON.parse(event.data.substring(19));
                    document.getElementById('first_word_options_list').innerHTML = '';
                    for (var i = 0; i < options.length; i++) {
                        var option = options[i];
                        var button = document.createElement('button');
                        button.innerHTML = option;
                        button.classList.add('first_word_option');
                        button.onclick = function () {
                            socket.send('[first_word_choosed]' + this.innerHTML);
                            document.getElementById('first_word_options').style.display = 'none';
                            document.getElementById('word').innerHTML = this.innerHTML;
                        };
                        document.getElementById('first_word_options_list').appendChild(button);
                    }



                    var time = 120;
                    document.getElementById('countdown_draw').textContent = time;
                    document.getElementById('countdown_draw').style.color = 'black';
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_draw').textContent = time;
                        if (time == 3) {
                            new Audio('assets/countdown.mp3').play();
                            document.getElementById('countdown_draw').style.color = 'red';
                        }
                        if (time <= 0 || phase != 'draw') {
                            if (time <= 0) {
                                if (getElementById('first_word_options').style.display == '') { socket.send('[first_word_choosed]' + options[0]); }
                                if (undoStack.length > 0) { submit_pic(); }
                            }
                            document.getElementById('first_word_options').style.display = 'none';
                            clearInterval(interval);
                        }
                    }, 1000);
                }
// 准备相关
else if (event.data.startsWith('[pready]')) {
    const name = event.data.substring(8);
    updatePlayerReadyStatus(name, true);
}
else if (event.data.startsWith('[unpready]')) {
    const name = event.data.substring(10);
    updatePlayerReadyStatus(name, false);
}
                //如果都不是，表示服务器直接发送的信息
                else {
                    chat('<span style="color: gray">' + event.data + '</div>');
                }

            };
            socket.onclose = function () {
                console.log('WebSocket连接关闭');
                alert("与服务器断开连接");
                if (phase == "draw" || phase == "guess") {
                    connectServer();
                    return;
                }
                return_to_main();
            };
            socket.onerror = function () {
                console.log('WebSocket连接出错');
                alert("连接服务器失败，请检查网络连接");
                return_to_main();
            };
            document.getElementById('server').style.display = 'none';
            document.getElementById('prepare').style.display = '';
        document.getElementById('readyBtn').textContent = "准备游戏";
        document.getElementById('waitingText').style.display = 'none';
            phase = "prepare";
        }

        // 提交图片
        function submit_pic() {
            if (!undoStack.length) {
                alert("啥也不画？");
                return;
            }
            if (undoStack.length > 10) {
                // 限制上传步数
                var last = undoStack[undoStack.length - 1];
                undoStack = undoStack.slice(0, undoStack.length - 1);
                var k = Math.floor(undoStack.length / 9);
                var res = [];
                for (var i = 0; i < 9; i++) {
                    res.push(undoStack[k * i + 1]);
                }
                undoStack = res.concat(last);
            }
            socket.send("[draw]" + JSON.stringify(undoStack));
            document.getElementById('black').style.display = '';
            is_black = true;
            document.getElementById('waiting').style.display = '';
        }

        // 提交答案
        function submitGuess() {
            var guess = document.getElementById('guess').value;
            if (guess == "") {
                alert("啥也不猜？");
                return;
            }
            document.activeElement.blur(); // 关闭键盘
            socket.send("[guess]" + guess);
            document.getElementById('black').style.display = '';
            is_black = true;
            document.getElementById('waiting').style.display = '';
        }

        // 是否匹配
        function match(is_matched) {
            socket.send("[appreciation]" + is_matched);
            document.getElementById('waiting').style.display = '';
            document.getElementById('match_window').style.display = 'none';
        }

        // 闭包

        function choosePicture(outerVariable) {
            // 选择最喜欢的画作
            return function () {
                socket.send("[favourite]" + outerVariable);
                document.getElementById('favourite').style.display = 'none';
                document.getElementById('waiting').style.display = '';
            }
        }

        // chatbox
        function chatbox() {
            if (document.getElementById('chat').style.display == '') {
                document.getElementById('chat').style.display = 'none';
                if (!is_black) { document.getElementById('black').style.display = 'none'; }
            } else {
                document.getElementById('chat').style.display = '';
                document.getElementById('black').style.display = '';
                var chat_display = document.getElementById('messages');
                chat_display.scrollTop = chat_display.scrollHeight;
                if (!is_touch) { document.getElementById('chat_input').focus(); }
            }
        }

        // toolbar
        function toolbar() {
            if (document.getElementById('toolbar').classList.contains('display')) {
                document.getElementById('toolbar').classList.remove('display');
            } else {
                document.getElementById('toolbar').classList.add('display');
            }
        }

        function clear_window() {
            if (phase != "appreiation") {
                document.getElementById('black').style.display = 'none';
                is_black = false;
                document.getElementById('chat').style.display = 'none';
                document.getElementById('waiting').style.display = 'none';
            }
        }

        function restart() {
            socket.send("[initialization]" + nickname + "," + player_id + "," + version);
            phase = "prepare";
            document.getElementById('prepare').style.display = '';
            document.getElementById('game_over').style.display = 'none';
            document.getElementById('rank').innerHTML = '';
        }

        function chat(message) {
            var chat_display = document.getElementById('messages');
            var chat_pre = document.getElementById("chat_preview_list");
            var chat_item = document.createElement('li');
            chat_item.innerHTML = message;
            chat_display.appendChild(chat_item.cloneNode(true));
            chat_display.scrollTop = chat_display.scrollHeight;
            chat_item.classList.add("fade");
            chat_pre.appendChild(chat_item);
            chat_pre.scrollTop = chat_pre.scrollHeight;
            setTimeout(function () {
                chat_pre.removeChild(chat_item);
            }, 4000);
        }

        function chat_send() {
            /**
              *@type {string} content
            */
            var content = document.getElementById('chat_input').value;
            if (!content) { return; }
            document.getElementById('chat_input').value = '';
            if (content.startsWith("/")) {
                // 指令
                content = content.substring(1);
                var flag = false
                var flag_index;
                var res = content.split('');
                const SPLIT_SYMBOL = "|";
                for (var i = 0; i < content.length; i++) {
                    if (content[i] == ' ' && !flag) { res[i] = SPLIT_SYMBOL; }
                    if (content[i] == '"') {
                        if (flag) {
                            if (i != content.length - 1) {
                                if (content[i + 1] != ' ') { chat("<div style='color: red'>语法错误：unexpected \"</div>"); return; }
                            }
                        } else {
                            if (i == 0) { chat("<div style='color: red'>语法错误：unexpected \" at begining.</div>"); return; }
                            if (content[i - 1] != ' ') { chat("<div style='color: red'>语法错误：unexpected \"</div>"); return; }
                            flag_index = i;
                        }
                        flag = !flag;

                    }

                }
                if (flag) { chat("<div style='color: red'>语法错误：unfinished \"</div>"); return; }

                content = res.join("").replace(/"/g, "");
                var cmd_blocks = content.split(SPLIT_SYMBOL);
                if (cmd_blocks[0] == "help") {
                    if (!check_arguements_num(cmd_blocks.length, [0, 1])) { return; }
                    if (cmd_blocks.length == 1) {
                        chat("<div style='color: gray'>/help [command] - 获取帮助<br>/ping - 获取延迟<br>/debug &lt;type&gt; [arguements] - debug模式<br>/get <item> - 获取服务器数据<br>/send &lt;message&gt; - 向服务器发送信息<br>以下需要管理员权限：<br>/start - 开始游戏<br>/close - 关闭服务器<br>/set - 房间设置</div>");
                    } else {
                        if (cmd_blocks[1] == "ping") {
                            chat("<div style='color: gray'>/ping - 获取延迟<br>延迟的计算以本地时间为准，结果显示在聊天栏。</div>");
                        } else if (cmd_blocks[1] == "debug") {
                            //to do
                        } else if (cmd_blocks[1] == "get") {
                            chat("<div style='color: gray'>/get &lt;item&gt; - 获取服务器数据<br>获取的数据会显示在聊天栏。<br>可获取的数据有：<br>players - 获取玩家列表<br>chains - 获取所有传递链<br>turn_now - <br>num_turn - 游戏回合数</div>");
                        } else if (cmd_blocks[1] == "start") {
                            chat("<div style='color: gray'>/start - 开始游戏<br>开始游戏后，玩家将无法加入游戏。</div>");
                        } else if (cmd_blocks[1] == "close") {
                            chat("<div style='color: gray'>/close - 关闭服务器<br>这将踢出所有玩家。</div>");
                        } else if (cmd_blocks[1] == "send") {
                            chat("<div style='color: gray'>/send &lt;message&gt; - 向服务器发送信息</div>");
                        } else {
                            chat("<div style='color: red'>没有" + cmd_blocks[1] + "的相关帮助。</div>");
                        }
                    }
                } else if (cmd_blocks[0] == "ping") {
                    if (!check_arguements_num(cmd_blocks.length, 0)) { return; }
                    if (!ping_start_time == 0) { chat("<div style='color: red'>正在ping...</div>"); return; }
                    if (check_server_connected()) {
                        ping_start_time = new Date().getTime();
                        socket.send("p");
                    } else { chat("<div style='color: red'>未连接服务器</div>"); return; }
                } else if (cmd_blocks[0] == "start") {
                    if (!check_arguements_num(cmd_blocks.length, 0)) { return; }
                    if (check_server_connected()) {
                        socket.send("[admin]start");
                    } else { chat("<div style='color: red'>未连接服务器</div>"); return; }

                } else if (cmd_blocks[0] == "close") {
                    if (!check_arguements_num(cmd_blocks.length, 0)) { return; }
                    if (check_server_connected()) {
                        socket.send("[admin]close");
                    } else { chat("<div style='color: red'>未连接服务器</div>"); return; }

                } else if (cmd_blocks[0] == "send") {
                    if (!check_arguements_num(cmd_blocks.length, 1)) { return; }
                    if (check_server_connected()) {
                        socket.send(cmd_blocks[1]);
                    } else { chat("<div style='color: red'>未连接服务器</div>"); return; }

                } else if (cmd_blocks[0] == "debug") {
                    if (cmd_blocks[1] == "scene") {
                        if (!check_arguements_num(cmd_blocks.length, 2)) { return; }

                        if (!scenes.includes(cmd_blocks[2])) {
                            chat("<div style='color: red'>参数必须是" + scenes + "中的一个</div>");
                            return;
                        }
                        Array.prototype.forEach.call(document.getElementsByClassName('scene'), function (element) {
                            element.style.display = "none";
                        });
                        document.getElementById(cmd_blocks[2]).style.display = "";
                    } else if (cmd_blocks[1] == "account") {
                        if (!check_arguements_num(cmd_blocks.length, [2, 3])) { return; }
                        if (cmd_blocks[2] == "get") {
                            var account = localStorage.getItem("dg_id");
                            if (account) { chat("<div style='color: gray'>ID：" + account + "</div>"); }
                            else { chat("<div style='color: red'>未存储ID</div>"); }
                        } else if (cmd_blocks[2] == "set") {
                            if (!check_arguements_num(cmd_blocks.length, 3)) { return; }
                            if (confirm("账号切换：是否将ID设置为" + cmd_blocks[3] + "？请确保格式正确。")) {
                                localStorage.setItem("dg_id", cmd_blocks[3]);
                                chat("<div style='color: gray'>ID已修改</div>");
                            }
                        } else { chat("<div style='color: red'>未知参数：" + cmd_blocks[2] + "</div>"); }

                    } else if (cmd_blocks[1] == "cmd") {
                        if (!check_arguements_num(cmd_blocks.length, 2)) { return; }
                        try {
                            var a = eval(cmd_blocks[2]);
                        } catch (e) { chat("<div style='color: red'>" + e + "</div>"); }
                        chat("<div style='color: gray'>" + a + "</div>");
                    } else if (cmd_blocks[1] == "test") {
                        if (!check_arguements_num(cmd_blocks.length, 2)) { return; }
                        if (cmd_blocks[2] == "audio") {
                            new Audio("assets/win.mp3").play();
                        }
                    }

                    else {
                        chat("<div style='color: red'>未知参数：" + cmd_blocks[1] + "</div>");
                    }
                } else if (cmd_blocks[0] == "get") {
                    if (!check_arguements_num(cmd_blocks.length, 1)) { return; }

                    if (!items.includes(cmd_blocks[1])) {
                        chat("<div style='color: red'>参数必须是" + items + "中的一个</div>");
                        return;
                    }
                    if (check_server_connected()) {
                        socket.send("[get]" + cmd_blocks[1]);
                    } else { chat("<div style='color: red'>未连接服务器</div>"); return; }

                } else if (cmd_blocks[0] == "set") {
                    if (!check_arguements_num(cmd_blocks.length, 2)) { return; }
                    if (!check_server_connected()) { chat("<div style='color: red'>未连接服务器</div>"); return; }
                    if (cmd_blocks[1] == "wordbook") {
                        socket.send("[set_wordbook]" + cmd_blocks[2]);
                    }
                    else if (cmd_blocks[1] == "turn_num") {
                        if (/^-?\d+$/.test(cmd_blocks[2])) {
                            socket.send("[set_turn_num]" + cmd_blocks[2]);
                        } else { chat("<div style='color: red'>参数必须是数字</div>"); return; }
                    }
                }



                else {
                    chat("<div style='color: red'>未知指令：" + cmd_blocks[0] + "</div>");
                }
            } else {
                if (!check_server_connected()) { chat("<div style='color: red'>未连接服务器</div>"); return; }
                socket.send("[chat]" + content);
            }

        }

        function check_arguements_num(blocks_length, num) {
            if (typeof num == "number") { num = [num]; }
            if (!num.includes(blocks_length - 1)) {
                var num_str = "";
                for (var i = 0; i < num.length; i++) {
                    if (i != 0) { num_str += "或"; }
                    num_str += num[i];
                }
                chat("<div style='color: red'>指令要求" + num_str + "个参数，但提供了" + (blocks_length - 1) + "个参数</div>");
                return false;
            } else {
                return true;
            }
        }

        function check_server_connected() {
            if (socket) {
                if (socket.readyState != 1 || phase == "end") {
                    return false;
                } else {
                    return true;
                }
            } else {
                return false;
            }


        }
        // 聊天框快捷键
        window.addEventListener('keydown', function (e) {
            if (document.getElementById("settings").style.display != "none") { return; }
            if (document.getElementById("chat").style.display == "none" && document.activeElement.tagName != "INPUT") {
                if (e.key == "Enter" || e.key == "/" || e.key == "t") {
                    e.preventDefault();
                    if (e.key == "/" && document.getElementById("chat_input").value == "") { document.getElementById("chat_input").value = "/" }
                    chatbox();
                }
            } else if (e.keyCode == 27) {
                chatbox();
            }
        });

        // 回到主界面
        function return_to_main() {
            document.getElementById("server").style.display = "";
            document.getElementById("prepare").style.display = "none";
            document.getElementById("drawing_phase").style.display = "none";
            document.getElementById("chat").style.display = "none";
            document.getElementById("waiting").style.display = "none";
            document.getElementById("guess_phase").style.display = "none";
            document.getElementById("appreciation_phase").style.display = "none";
            document.getElementById("favourite").style.display = "none";
            document.getElementById("favourite_choosed").style.display = "none";
            document.getElementById("game_over").style.display = "none";
            document.getElementById("black").style.display = "none";
            is_black = false;
        }


        window.addEventListener('beforeunload', function (event) {
            if (phase == "prepare" || phase == "end") { return; }
            event.returnValue = '真的要退出吗？';
        });

        document.getElementById("black").addEventListener("click", function () {
            if (document.getElementById("chat").style.display != "none" && is_black == false) {
                chatbox();
            }
        })

        chat("<span style='color: gray'>欢迎来到Draw&Guess！您可以输入/help获取帮助。</span>");

        function clearStorage() {
            if (confirm("确定要清空本地存储吗？这会删除所有游戏数据，包括您的游戏进度和设置。")) {
                if (confirm("二次确认：您真的要清空本地存储吗？如果遇到问题，请多尝试几次。")) {
                    localStorage.clear();
                    alert("已清空本地存储");
                }
            }
        }

        document.getElementById("version").innerHTML = "v" + version;


        // 画板代码


        // 当前画笔模式：1 空心矩形 2 实心矩形 3 空心圆形 4 实心圆形 5 直线 6 箭头 7 自由画笔 8 橡皮
        let brush = 7;

        // 获取画布和绘画工具
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');


        // 跟踪绘画状态
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        let isDrawing = false; //标记是否要绘制
        let isMouseDown = false; //标记鼠标是否按下
        let lineColor; // 线条颜色
        let lineWidth; // 线条粗细
        let points = []; //存储坐标点
        let undoStack = []; // 存储画布状态，用于撤销上一步操作
        let step = 0; // 记录当前步数
        let brushSize = 3.323396301269531; // 画笔大小
        let canvas_width = 1340;
        let canvas_height = 700;

        // 根据窗口设置画布大小
        if (window.innerWidth / window.innerHeight > canvas_width / canvas_height) {
            canvas_width = canvas_height * (window.innerWidth / window.innerHeight);
        }
        else {
            canvas_height = canvas_width * (window.innerHeight / window.innerWidth);
        }

        canvas.width = canvas_width;
        canvas.height = canvas_height;





        // 鼠标按下
        canvas.onpointerdown = function (e) {
            points = [];
            isDrawing = true;
            isMouseDown = true;
            points.push({ x: e.offsetX * (canvas_width / window.innerWidth), y: e.offsetY * (canvas_height / window.innerHeight) });
            if (e.ctrlKey || brush === 8) { // 如果是橡皮擦，则设置为destination-out
                ctx.globalCompositeOperation = 'destination-out';
            } else { // 否则设置为默认值source-over
                ctx.globalCompositeOperation = 'source-over';
            }
            ctx.beginPath(); // 新增：开始一个绘画路径
            pointermove(e);
        };


        // 鼠标抬起
        canvas.onpointerup = function (e) {
            isMouseDown = false;
            points = [];
            isDrawing = false;
            ctx.closePath(); // 新增：结束绘画路径
            // 绘画结束后，将值重新设置为默认值，否则当前值为destination-out时，使用撤销功能后会把整个画布的内容都给擦掉
            ctx.globalCompositeOperation = 'source-over';
            addUndoStack(canvas.toDataURL("image/webp", 0.5)); // 将当前画布状态保存起来
        };
        // 鼠标离开画布
        canvas.onpointerout = function (e) {
            if (isMouseDown) {
                points = [];
                isDrawing = false;
                isMouseDown = false;
                ctx.closePath(); // 新增：结束绘画路径
                ctx.globalCompositeOperation = 'source-over';
                // 绘画结束后，将值重新设置为默认值，否则当前值为destination-out时，使用撤销功能后会把整个画布的内容都给擦掉
                addUndoStack(canvas.toDataURL("image/webp", 0.5)); // 将当前画布状态保存起来
            }
        };
        function pointermove(e) {
            if (!isDrawing) return;
            lineColor = document.getElementById('brushColor').value;
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = lineColor;
            draw(e.offsetX * (canvas_width / window.innerWidth), e.offsetY * (canvas_height / window.innerHeight), e.ctrlKey);
        }
        // 鼠标移动
        canvas.onpointermove = pointermove;

        window.addEventListener('touchstart', function check_touch() {
            console.log('检测到触摸屏');
            is_touch = true;
            canvas.onpointermove = function (e) {
            }
            canvas.onpointerup = function (e) {
            }
            canvas.onpointerdown = function (e) {
            }
            canvas.onpointerout = function (e) {
            }
            window.removeEventListener('touchstart', check_touch);
            colorpicker = new Colorpicker({
                el: "brushColor",
                color: "#000000",
                change: function (elem, hex) {
                    document.getElementById('brushColor').value = hex;
                }
            });
        });
        function touchmove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            lineColor = document.getElementById('brushColor').value;
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = lineColor;
            draw(e.touches[0].clientX * (canvas_width / window.innerWidth), e.touches[0].clientY * (canvas_height / window.innerHeight), e.ctrlKey);

        }
        // 触摸
        canvas.addEventListener('touchmove', touchmove, { passive: false });

        canvas.addEventListener('touchstart', (e) => {
            points = [];
            isDrawing = true;
            isMouseDown = true;
            points.push({ x: e.touches[0].clientX * (canvas_width / window.innerWidth), y: e.touches[0].clientY * (canvas_height / window.innerHeight) });
            if (e.ctrlKey || brush === 8) { // 如果是橡皮擦，则设置为destination-out
                ctx.globalCompositeOperation = 'destination-out';
            } else { // 否则设置为默认值source-over
                ctx.globalCompositeOperation = 'source-over';
            }
            ctx.beginPath(); // 新增：开始一个绘画路径
            touchmove(e);
        }, { passive: false });
        canvas.addEventListener('touchend', (e) => {
            isMouseDown = false;
            points = [];
            isDrawing = false;
            ctx.closePath(); // 新增：结束绘画路径
            // 绘画结束后，将值重新设置为默认值，否则当前值为destination-out时，使用撤销功能后会把整个画布的内容都给擦掉
            ctx.globalCompositeOperation = 'source-over';
            addUndoStack(canvas.toDataURL("image/webp", 0.5)); // 将当前画布状态保存起来
        }, { passive: false });

        // 绘制
        function draw(mousex, mousey, ctrlKey) {
            points.push({ x: mousex, y: mousey });
            if (ctrlKey || brush === 7 || brush === 8) { // 如果是橡皮擦模式，则和画笔模式一样，用draw画笔方法。
                draw画笔();
            } else {
                if (brush === 1) draw矩形(false);
                else if (brush === 2) draw矩形(true);
                else if (brush === 3) draw圆形(false);
                else if (brush === 4) draw圆形(true);
                else if (brush === 5) draw直线();
                else if (brush === 6) draw箭头();
            }
            ctx.stroke();
            points.slice(0, 1);
        }

        // 绘制自由线条
        function draw画笔() {
            ctx.beginPath();
            let x = (points[points.length - 2].x + points[points.length - 1].x) / 2,
                y = (points[points.length - 2].y + points[points.length - 1].y) / 2;
            if (points.length == 2) {
                ctx.moveTo(points[points.length - 2].x, points[points.length - 2].y);
                ctx.lineTo(x, y);
            } else {
                let lastX = (points[points.length - 3].x + points[points.length - 2].x) / 2,
                    lastY = (points[points.length - 3].y + points[points.length - 2].y) / 2;
                ctx.moveTo(lastX, lastY);
                ctx.quadraticCurveTo(points[points.length - 2].x, points[points.length - 2].y, x, y);
            }
        }

        // 绘制矩形
        function draw矩形(isSolid) {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            if (isSolid) { // 是否实心，true绘制实心矩形，false绘制空心矩形
                ctx.fillStyle = lineColor;
                ctx.fillRect(startX, startY, endX - startX, endY - startY);
            } else {
                ctx.rect(startX, startY, endX - startX, endY - startY);
            }
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }

        // 绘制圆形
        function draw圆形(isSolid) {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
            if (isSolid) { // 绘制实心圆
                ctx.fillStyle = lineColor;
                ctx.fill();
            }
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }

        // 绘制直线
        function draw直线() {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }

        // 绘制箭头
        function draw箭头() {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            const arrowSize = lineWidth * 4; // 箭头大小（根据线条粗细来调整箭头大小）
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            // 计算箭头角度
            const angle = Math.atan2(endY - startY, endX - startX);
            // 绘制箭头部分
            ctx.lineTo(
                endX - arrowSize * Math.cos(angle - Math.PI / 6),
                endY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(endX, endY);
            ctx.lineTo(
                endX - arrowSize * Math.cos(angle + Math.PI / 6),
                endY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }


        // 加载图片
        function loadImage() {
            if (step > 0) {
                var img = new Image();
                img.src = undoStack[step - 1];
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            }
        }

        // 清空画布
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            step = 0;
            points = [];
            undoStack = []; // 清空撤销栈
        }

        // 添加操作
        function addUndoStack(url) {
            if (step < undoStack.length) {
                undoStack.length = step; // 清除撤销后的操作
            }
            undoStack.push(url);
            step++;
        }

        // 撤销操作
        function undo() {
            if (step > 1) {
                step--;
                const image = new Image();
                image.src = undoStack[step - 1]; // 获取上一个画布状态
                image.onload = function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0); // 绘制上一个画布状态
                }
            } else {
                step = 0;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // 恢复操作
        function restore() {
            if (step < undoStack.length) {
                step++;
                const image = new Image();
                image.src = undoStack[step - 1]; // 获取下一个画布状态
                image.onload = function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0); // 绘制下一个画布状态
                }
            }
        }

        // 保存图片
        function save_pic() {
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = 'drawing.png';
            link.click();
        }

        function change_mode(id, val) {
            brush = val;
            update_tool_now(val);
        }

        // 监听键盘事件，实现撤销操作和保存绘画内容、切换画笔工具
        window.addEventListener('keydown', (e) => {
            // 撤销
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            // 恢复
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                restore();
            }
            // 保存
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                save_pic();
            }
            // 橡皮快捷键
            if (e.ctrlKey) {
                update_tool_now(8);
            }
        })
        window.addEventListener('keyup', (e) => {
            update_tool_now(brush);
        })
        function update_tool_now(target) {
            var display;
            if (target == 1) { display = '空心矩形' }
            else if (target == 2) { display = '实心矩形' }
            else if (target == 3) { display = '空心圆形' }
            else if (target == 4) { display = '实心圆形' }
            else if (target == 5) { display = '直线' }
            else if (target == 6) { display = '箭头' }
            else if (target == 7) { display = '画笔' }
            else if (target == 8) { display = '橡皮' }

            Array.prototype.forEach.call(document.getElementsByClassName('painter_mode_chose_button'), function (element) {
                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                }
            });
            document.getElementById(display).classList.add('active');
        }

        function change_color(val) {
            document.getElementById('brushColor').value = val;
            if (is_touch) {
                colorpicker.current_mode = "hex";
                colorpicker.setColorByInput(val);
            }
        }

        function change_linewidth(id, width) {
            brushSize = width;
            document.getElementById('linewidth_1').classList.remove('active');
            document.getElementById('linewidth_2').classList.remove('active');
            document.getElementById('linewidth_3').classList.remove('active');
            document.getElementById('linewidth_4').classList.remove('active');
            document.getElementById('linewidth_' + id).classList.add('active');
            if (id == 1) {
                document.getElementById('canvas').style.cursor = "url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22none%22%20viewBox%3D%220%200%204.6875%204.6875%22%20width%3D%224.6875%22%20height%3D%224.6875%22%3E%3Cellipse%20cx%3D%222.34375%22%20cy%3D%222.34375%22%20rx%3D%221.171875%22%20ry%3D%221.171875%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23FFF%22%20stroke-width%3D%223.171875%22%2F%3E%3Cellipse%20cx%3D%222.34375%22%20cy%3D%222.34375%22%20rx%3D%221.171875%22%20ry%3D%221.171875%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23222222%22%20stroke-width%3D%221.171875%22%2F%3E%3C%2Fsvg%3E) 2.34375 2.34375, crosshair";
            } else if (id == 2) {
                document.getElementById('canvas').style.cursor = "url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22none%22%20viewBox%3D%220%200%207.031249999999999%207.031249999999999%22%20width%3D%227.031249999999999%22%20height%3D%227.031249999999999%22%3E%3Cellipse%20cx%3D%223.5156249999999996%22%20cy%3D%223.5156249999999996%22%20rx%3D%222.34375%22%20ry%3D%222.34375%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23FFF%22%20stroke-width%3D%223.171875%22%2F%3E%3Cellipse%20cx%3D%223.5156249999999996%22%20cy%3D%223.5156249999999996%22%20rx%3D%222.34375%22%20ry%3D%222.34375%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23222222%22%20stroke-width%3D%221.171875%22%2F%3E%3C%2Fsvg%3E) 3.5156249999999996 3.5156249999999996, crosshair";
            } else if (id == 3) {
                document.getElementById('canvas').style.cursor = "url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22none%22%20viewBox%3D%220%200%2014.062499999999998%2014.062499999999998%22%20width%3D%2214.062499999999998%22%20height%3D%2214.062499999999998%22%3E%3Cellipse%20cx%3D%227.031249999999999%22%20cy%3D%227.031249999999999%22%20rx%3D%225.859375%22%20ry%3D%225.859375%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23FFF%22%20stroke-width%3D%223.171875%22%2F%3E%3Cellipse%20cx%3D%227.031249999999999%22%20cy%3D%227.031249999999999%22%20rx%3D%225.859375%22%20ry%3D%225.859375%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23222222%22%20stroke-width%3D%221.171875%22%2F%3E%3C%2Fsvg%3E) 7.031249999999999 7.031249999999999, crosshair"
            } else if (id == 4) {
                document.getElementById('canvas').style.cursor = "url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20fill%3D%22none%22%20viewBox%3D%220%200%2025.78125%2025.78125%22%20width%3D%2225.78125%22%20height%3D%2225.78125%22%3E%3Cellipse%20cx%3D%2212.890625%22%20cy%3D%2212.890625%22%20rx%3D%2211.71875%22%20ry%3D%2211.71875%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23FFF%22%20stroke-width%3D%223.171875%22%2F%3E%3Cellipse%20cx%3D%2212.890625%22%20cy%3D%2212.890625%22%20rx%3D%2211.71875%22%20ry%3D%2211.71875%22%20stroke-opacity%3D%221%22%20stroke%3D%22%23222222%22%20stroke-width%3D%221.171875%22%2F%3E%3C%2Fsvg%3E) 12.890625 12.890625, crosshair"
            }

        }


        // 确认按钮

        const submit_btn = document.getElementById('confirmButton');
        let timer = null;
        let longPressThreshold = 1000; // 长按阈值，单位为毫秒

        submit_btn.addEventListener('mousedown', function (event) {
            submit_btn.classList.add('pressed'); // 添加一个CSS类来改变按钮的样式
            timer = setTimeout(() => {
                // 长按效果
                submit_pic();
            }, longPressThreshold);
        });

        submit_btn.addEventListener('mouseup', function () {
            clearTimeout(timer); // 清除定时器，防止触发长按效果
            submit_btn.classList.remove('pressed'); // 移除长按样式
        });

        submit_btn.addEventListener('mouseleave', function () {
            clearTimeout(timer); // 如果鼠标离开按钮，也清除定时器
            submit_btn.classList.remove('pressed'); // 移除长按样式
        });

        // 添加触摸事件监听器
        submit_btn.addEventListener('touchstart', function (event) {
            event.preventDefault(); // 阻止默认行为，防止点击事件被触发
            submit_btn.classList.add('pressed'); // 添加一个CSS类来改变按钮的样式
            timer = setTimeout(() => {
                // 长按效果
                submit_pic();
                submit_btn.classList.remove('pressed');
            }, longPressThreshold);
        });

        submit_btn.addEventListener('touchend', function () {
            clearTimeout(timer); // 清除定时器，防止触发长按效果
            submit_btn.classList.remove('pressed'); // 移除长按样式
        });

        document.addEventListener("contextmenu", function (event) {
            event.preventDefault();
        });

        function openURL(url) {
            if (window.plus) {
                // 如果是在App中运行，则使用plus.runtime.openURL打开链接
                plus.runtime.openURL(url);
            } else {
                // 如果是在浏览器中运行，则使用window.open打开链接
                window.open(url);
            }
        }
        // 退出二次确认
        document.addEventListener('plusready', function () {
            var first = null;
            var webview = plus.webview.currentWebview();
            console.log("ready");
            plus.key.addEventListener('backbutton', function () {
                webview.canBack(function (e) {
                    if (e.canBack) {
                        webview.back();
                    } else {
                        //首次按键，提示‘再按一次退出应用’
                        if (!first) {
                            first = new Date().getTime(); //获取第一次点击的时间戳
                            plus.nativeUI.toast("再按一次退出游戏", {
                                duration: 'short'
                            }); //通过H5+ API 调用Android 上的toast 提示框
                            setTimeout(function () {
                                first = null;
                            }, 2000);
                        } else {
                            if (new Date().getTime() - first < 2000) { //获取第二次点击的时间戳, 两次之差 小于 2000ms 说明2s点击了两次,
                                plus.runtime.quit(); //退出应用
                            }
                        }
                    }
                });
            });
        });

        setInterval(function () {
            if (check_server_connected()) {
                if (ping_start_time == 0) {
                    ping_start_time = new Date().getTime();
                    socket.send("p");
                } else {
                    if (new Date().getTime() - ping_start_time > 5000) {
                        socket.close();
                    }
                }
            }
        }, 3000);

        // 设置相关
        var default_setting = {
            game_progress: true,
            chat_sound: true,
            shape_tool: false,
            girl_when_waiting: false,
        };
        var settings = {};
        function init_setting(setting) {
            if (!localStorage.getItem(setting)) {
                localStorage.setItem(setting, JSON.stringify(default_setting[setting]));
                if (document.getElementById(setting).type == "checkbox") {
                    document.getElementById(setting).checked = default_setting[setting];
                } else {
                    document.getElementById(setting).value = default_setting[setting];
                }
                settings[setting] = default_setting[setting];
            } else {
                if (document.getElementById(setting).type == "checkbox") {
                    document.getElementById(setting).checked = JSON.parse(localStorage.getItem(setting));
                } else {
                    document.getElementById(setting).value = JSON.parse(localStorage.getItem(setting));
                }
                settings[setting] = JSON.parse(localStorage.getItem(setting));
            }
        }
        init_setting("game_progress");
        init_setting("chat_sound");
        init_setting("shape_tool");
        init_setting("girl_when_waiting");

        function showSettings() {
            document.getElementById("settings").style.display = "";
        }

        function closeSettings() {
            document.getElementById("settings").style.display = "none";
        }
        function change_settings() {
            localStorage.setItem("game_progress", JSON.stringify(document.getElementById("game_progress").checked));
            localStorage.setItem("chat_sound", JSON.stringify(document.getElementById("chat_sound").checked));
            localStorage.setItem("shape_tool", JSON.stringify(document.getElementById("shape_tool").checked));
            localStorage.setItem("girl_when_waiting", JSON.stringify(document.getElementById("girl_when_waiting").checked));
            location.reload();
        }
        if (!settings.shape_tool) {
            document.getElementById("painter_mode_btns").style.display = "none";
        }


// 准备/取消准备功能
function toggleReady() {
    isReady = !isReady;
    if(isReady) {
        socket.send("[pready]");
        document.getElementById('readyBtn').textContent = "取消准备";
        document.getElementById('waitingText').style.display = '';
    } else {
        socket.send("[unpready]");
        document.getElementById('readyBtn').textContent = "准备游戏";
        document.getElementById('waitingText').style.display = 'none';
    }
}

// 更新玩家准备状态的函数
function updatePlayerReadyStatus(name, isReady) {
    const playerList = document.getElementById('players').getElementsByTagName('li');
    for(let li of playerList) {
        if(li.childNodes[0].textContent == name) {
            let img = li.querySelector('.ready-status');
            if(!img) {
                img = document.createElement('img');
                img.className = 'ready-status';
                li.appendChild(img);
            }
            img.src = isReady ? 'assets/right.png' : 'assets/wrong.png';
            img.alt = isReady ? '已准备' : '未准备';
            break;
        }
    }
}
    </script>

    <script src="girl/index.js"></script>

    <script src="js/colorpicker.js"></script>
    <script>

    </script>

</body>

</html>